<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthPlus | Your Health, Delivered</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for Admin Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' },
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' },
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'bounce-slower': 'bounce 4s infinite',
                        'fade-in': 'fadeIn 0.4s ease-in-out',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(20, 184, 166, 0.5)'
                    }
                }
            }
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Cart Modal Styles to center it */
        .modal-center { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans min-h-screen flex flex-col transition-colors duration-300">

<!-- Toast Container -->
<div id="toast-container" class="fixed top-24 right-5 z-[70] flex flex-col gap-3 pointer-events-none"></div>

<!-- Navigation -->
<nav class="sticky top-0 z-50 bg-white dark:bg-slate-800 shadow-md dark:shadow-slate-900/50 transition-colors duration-300">
    <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-between gap-4">

            <!-- Logo -->
            <div class="flex items-center gap-2 cursor-pointer flex-shrink-0 group" onclick="showPage('page-home')">
                <div class="bg-teal-500 p-2 rounded-lg text-white shadow-sm transition-all duration-300 transform group-hover:scale-110 group-hover:shadow-glow">
                    <!-- Plus Icon SVG -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </div>
                <span class="text-2xl font-bold text-teal-600 dark:text-teal-400 hidden sm:block tracking-tight">HealthPlus</span>
            </div>

            <!-- Desktop Menu Links -->
            <div class="hidden md:flex items-center space-x-6 mx-6">
                <a href="#" onclick="showPage('page-home')" class="text-sm font-semibold hover:text-teal-600 dark:text-slate-200 dark:hover:text-teal-400 transition">Shop</a>
                <a href="#" id="nav-contact-link" onclick="showPage('page-contact')" class="text-sm font-semibold hover:text-teal-600 dark:text-slate-200 dark:hover:text-teal-400 transition">Contact Us</a>
                <a href="#" onclick="showPage('page-about')" class="text-sm font-semibold hover:text-teal-600 dark:text-slate-200 dark:hover:text-teal-400 transition">About Us</a>
            </div>

            <!-- Desktop Search -->
            <div class="hidden md:flex flex-1 max-w-lg relative">
                <input type="text" placeholder="Search medicines..."
                       class="w-full pl-10 pr-4 py-2 border border-slate-200 dark:border-slate-600 rounded-full focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all bg-slate-50 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 focus:bg-white dark:focus:bg-slate-600"
                       oninput="filterProducts(this.value)"
                       onkeydown="if(event.key==='Enter') document.getElementById('product-section').scrollIntoView({behavior:'smooth'})">
                            <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400 dark:text-slate-300 text-xl"></i>
            </div>

<!-- Icons & Actions -->
            <div class="hidden md:flex items-center gap-6 flex-shrink-0">
                <button onclick="document.getElementById('upload-modal').classList.remove('hidden')"
                        class="flex items-center gap-2 text-sm font-medium text-teal-600 dark:text-teal-300 hover:text-teal-700 dark:hover:text-teal-200 transition-colors bg-teal-50 dark:bg-teal-900/30 px-3 py-2 rounded-full hover:bg-teal-100 dark:hover:bg-teal-800/50">
                    <i class="ph ph-upload-simple text-lg"></i> Upload Rx
                </button>

                <div class="flex items-center gap-4 text-slate-600 dark:text-slate-300">
                    <!-- Guest Auth -->
                    <div id="nav-guest" class="flex gap-3 text-sm font-medium">
                        <button onclick="showPage('page-login')" class="hover:text-teal-600 dark:hover:text-teal-400">Login</button>
                        <span>|</span>
                        <button onclick="showPage('page-register')" class="hover:text-teal-600 dark:hover:text-teal-400">Register</button>
                    </div>

                    <!-- User Profile -->
                    <div id="nav-user" class="hidden flex items-center gap-3">
                        <button onclick="showPage('page-profile')" class="hover:text-teal-600 dark:hover:text-teal-400 transition-colors" title="My Profile"><i class="ph ph-user text-2xl"></i></button>
                        <button onclick="logout()" class="text-red-400 hover:text-red-600 dark:hover:text-red-400" title="Logout"><i class="ph ph-sign-out text-2xl"></i></button>
                    </div>

                    <!-- Admin Link -->
                    <div id="nav-admin" class="hidden">
                        <button onclick="showPage('page-admin-dashboard')" class="text-teal-600 dark:text-teal-300 font-bold border border-teal-200 dark:border-teal-700 px-3 py-1 rounded hover:bg-teal-50 dark:hover:bg-teal-900/20">Admin Panel</button>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="hover:text-teal-600 dark:hover:text-teal-400 transition-colors" title="Toggle Dark Mode">
                        <i id="dark-mode-icon" class="ph ph-moon text-2xl"></i>
                    </button>

                    <!-- Cart -->
                    <button onclick="toggleCart()" class="relative hover:text-teal-600 dark:hover:text-teal-400 transition-colors">
                        <i class="ph ph-shopping-cart text-2xl"></i>
                        <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full opacity-0 transition-opacity">0</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden text-slate-600 dark:text-slate-300 p-2" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <i class="ph ph-list text-2xl"></i>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4 border-t border-slate-100 dark:border-slate-700 animate-fade-in">
            <div class="relative mt-4 mb-4">
                <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-2 border border-slate-200 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 dark:text-white" oninput="filterProducts(this.value)">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400 dark:text-slate-300 text-xl"></i>
            </div>
            <div class="flex flex-col gap-4">
                <button onclick="toggleDarkMode()" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 font-medium">
                    <i class="ph ph-moon text-xl"></i> Toggle Theme
                </button>
                <button onclick="showPage('page-contact')" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 font-medium">Contact Us</button>
                <button onclick="showPage('page-about')" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 font-medium">About Us</button>
                <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" class="flex items-center gap-2 text-teal-600 dark:text-teal-400 font-medium">
                    <i class="ph ph-upload-simple text-xl"></i> Upload Prescription
                </button>
                <button onclick="showPage('page-profile')" class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                    <i class="ph ph-user text-xl"></i> My Account
                </button>
                <button onclick="toggleCart()" class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                    <i class="ph ph-shopping-cart text-xl"></i> Cart
                </button>
                <div id="mobile-auth-links" class="flex gap-4 pt-2 border-t dark:border-slate-700">
                    <button onclick="showPage('page-login')" class="text-slate-600 dark:text-slate-300 font-medium">Login</button>
                    <button onclick="showPage('page-register')" class="text-teal-600 dark:text-teal-400 font-medium">Register</button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main Page Content -->
<main id="main-container" class="flex-grow">

    <!-- HERO SECTION -->
    <div id="hero-section" class="bg-gradient-to-r from-teal-500 to-teal-700 text-white hidden fade-in">
        <div class="container mx-auto px-4 py-12 md:py-20 flex flex-col md:flex-row items-center justify-between">
            <div class="md:w-1/2 space-y-6">
                <span class="bg-teal-400/30 text-teal-50 px-3 py-1 rounded-full text-sm font-medium inline-block">Trusted by 1M+ Customers</span>
                <h1 class="text-4xl md:text-6xl font-bold leading-tight">Your Health, <br /> Delivered Fast.</h1>
                <p class="text-teal-50 text-lg md:text-xl max-w-md">Order medicines, vitamins, and personal care products from the comfort of your home.</p>
                <div class="flex gap-4 pt-4">
                    <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" class="bg-white text-teal-700 px-6 py-3 rounded-full font-bold shadow-lg hover:bg-slate-100 transition-all transform hover:scale-105">Upload Prescription</button>
                    <button onclick="document.getElementById('product-section').scrollIntoView({behavior: 'smooth'})" class="bg-teal-600 border border-teal-400 px-6 py-3 rounded-full font-bold hover:bg-teal-500 transition-all">Shop Now</button>
                </div>
            </div>
            <div class="md:w-1/2 mt-12 md:mt-0 flex justify-center relative">
                <!-- Illustration with Circle Animation -->
                <div class="relative group cursor-pointer flex items-center justify-center w-72 h-72">
                    <div class="absolute inset-0 border-4 border-white/30 rounded-full transition-all duration-500 group-hover:scale-110 group-hover:border-white/50"></div>
                    <i class="ph ph-pill text-[160px] text-white/90 drop-shadow-lg transition-transform duration-500 group-hover:-translate-y-4 group-hover:rotate-12 relative z-10"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. HOME / SHOP PAGE -->
    <div id="page-home" class="page container mx-auto px-4 py-12">
        <!-- Categories -->
        <div id="product-section" class="mb-12">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 dark:text-white">Shop by Category</h2>
            <div id="category-chips" class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide"></div>
        </div>

        <!-- Product Grid -->
        <div class="mb-16">
            <h2 id="current-category-title" class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Featured Products</h2>
            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>
    </div>

    <!-- 2. CONTACT US PAGE -->
    <div id="page-contact" class="page hidden container mx-auto px-4 mt-8 fade-in pb-12">
        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Get In Touch</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2">We are here to help you</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden max-w-4xl mx-auto">
            <!-- Left: Info (Green) -->
            <div class="bg-teal-600 p-10 text-white flex flex-col justify-between">
                <div>
                    <h3 class="text-2xl font-bold mb-6">Contact Information</h3>
                    <p class="text-teal-100 mb-8">Fill up the form and our team will get back to you within 24 hours.</p>

                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="ph ph-phone text-xl"></i></div>
                            <span>+20 123 456 7890</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="ph ph-envelope text-xl"></i></div>
                            <span>support@pharmaonline.com</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="ph ph-map-pin text-xl"></i></div>
                            <span>123 Health St, Cairo, Egypt</span>
                        </div>
                    </div>
                </div>
                <div class="mt-10 flex gap-4">
                    <a href="#" class="w-10 h-10 rounded-full border border-white/30 flex items-center justify-center hover:bg-white hover:text-teal-600 transition"><i class="ph ph-facebook-logo text-xl"></i></a>
                    <a href="#" class="w-10 h-10 rounded-full border border-white/30 flex items-center justify-center hover:bg-white hover:text-teal-600 transition"><i class="ph ph-twitter-logo text-xl"></i></a>
                    <a href="#" class="w-10 h-10 rounded-full border border-white/30 flex items-center justify-center hover:bg-white hover:text-teal-600 transition"><i class="ph ph-instagram-logo text-xl"></i></a>
                </div>
            </div>

            <!-- Right: Form (White) -->
            <div class="p-10 bg-white dark:bg-slate-800">
                <form onsubmit="event.preventDefault(); showToast('Message Sent'); this.reset();" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Your Name</label>
                        <input class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none dark:text-white" placeholder="John Doe" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
                        <input type="email" class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none dark:text-white" placeholder="john@example.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Message</label>
                        <textarea rows="4" class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none resize-none dark:text-white" placeholder="How can we help?" required></textarea>
                    </div>
                    <button class="w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 transition shadow-lg shadow-teal-500/30">Send Message</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. ABOUT US PAGE -->
    <div id="page-about" class="page hidden container mx-auto px-4 mt-8 fade-in pb-12">
        <div class="max-w-4xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-teal-600 p-12 text-center text-white">
                <div class="mb-4 flex justify-center">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold mb-4">About HealthPlus</h1>
                <p class="text-teal-100 text-lg">Your trusted partner in modern healthcare.</p>
            </div>
            <div class="p-10 space-y-6 text-slate-600 dark:text-slate-300 leading-relaxed text-lg">
                <p>
                    Founded in 2025, <strong>HealthPlus</strong> has revolutionized the way people access healthcare products in Egypt. We believe that health is the most valuable asset, and accessing quality medicines shouldn't be a hassle.
                </p>
                <p>
                    Our mission is to provide fast, reliable, and secure delivery of pharmaceuticals, vitamins, and personal care items directly to your doorstep. We partner with certified suppliers to ensure 100% authenticity of every product we sell.
                </p>
                <div class="grid md:grid-cols-3 gap-6 mt-8 pt-8 border-t border-slate-100 dark:border-slate-700">
                    <div class="text-center">
                        <div class="text-teal-600 dark:text-teal-400 font-bold text-3xl mb-2">1M+</div>
                        <div class="text-sm">Happy Customers</div>
                    </div>
                    <div class="text-center">
                        <div class="text-teal-600 dark:text-teal-400 font-bold text-3xl mb-2">5000+</div>
                        <div class="text-sm">Products</div>
                    </div>
                    <div class="text-center">
                        <div class="text-teal-600 dark:text-teal-400 font-bold text-3xl mb-2">24/7</div>
                        <div class="text-sm">Support</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. LOGIN & REGISTER PAGES -->
    <div id="page-login" class="page hidden w-full min-h-[calc(100vh-80px)] relative flex items-center justify-center fade-in overflow-hidden bg-teal-50 dark:bg-slate-900 transition-colors duration-300">

        <div class="absolute inset-0 z-0">
            <i class="ph ph-pill text-teal-200 dark:text-teal-900/40 text-9xl absolute -top-10 -left-10 opacity-50 animate-float" style="animation-duration: 6s;"></i>

            <i class="ph ph-heartbeat text-teal-200 dark:text-teal-900/40 text-[10rem] absolute -bottom-10 -right-10 opacity-50 animate-float" style="animation-delay: 1s;"></i>

            <i class="ph ph-flask text-teal-200 dark:text-teal-900/40 text-8xl absolute top-1/2 -left-12 opacity-30 animate-bounce-slow"></i>

            <i class="ph ph-first-aid text-teal-200 dark:text-teal-900/40 text-8xl absolute top-20 right-10 opacity-30 animate-float" style="animation-delay: 2s;"></i>

            <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-teal-300/20 dark:bg-teal-500/10 rounded-full blur-3xl"></div>
        </div>

        <div class="relative z-10 w-full max-w-md px-4">
            <div class="bg-white/80 dark:bg-slate-800/90 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-white/50 dark:border-slate-700 text-center transition-colors duration-300">
                <div class="w-16 h-16 bg-teal-100 dark:bg-teal-900/50 text-teal-600 dark:text-teal-400 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="ph ph-sign-in text-3xl"></i>
                </div>

                <h2 class="text-3xl font-bold mb-2 text-slate-800 dark:text-white">Welcome Back</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm">Sign in to access your prescriptions and orders.</p>

                <form id="login-form" class="space-y-5 text-left">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Email Address</label>
                        <div class="relative">
                            <i class="ph ph-envelope absolute left-3 top-3 text-slate-400 text-lg"></i>
                            <input name="email" type="email" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition dark:text-white" placeholder="name@example.com" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Password</label>
                        <div class="relative">
                            <i class="ph ph-lock-key absolute left-3 top-3 text-slate-400 text-lg"></i>
                            <input name="password" type="password" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition dark:text-white" placeholder="••••••••" required>
                        </div>
                    </div>

                    <div class="flex items-center justify-between text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="accent-teal-600 w-4 h-4 rounded">
                            <span class="text-slate-600 dark:text-slate-400">Remember me</span>
                        </label>
                        <a href="#" class="text-teal-600 font-bold hover:underline">Forgot Password?</a>
                    </div>

                    <button class="w-full bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 text-white py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 transform transition hover:-translate-y-0.5">Sign In</button>
                </form>

                <p class="mt-8 text-slate-600 dark:text-slate-400">
                    Don't have an account? <button onclick="showPage('page-register')" class="text-teal-600 dark:text-teal-400 font-bold hover:underline">Register</button>
                </p>
                <div class="mt-4 border-t dark:border-slate-700 pt-4"><button onclick="showPage('page-admin-login')" class="text-xs text-slate-400 dark:text-slate-500 hover:text-slate-600">Admin Access</button></div>
            </div>
        </div>
    </div>
    <div id="page-register" class="page hidden w-full min-h-[calc(100vh-80px)] relative flex items-center justify-center fade-in overflow-hidden bg-teal-50 dark:bg-slate-900 transition-colors duration-300">

        <div class="absolute inset-0 z-0">
            <i class="ph ph-shield-check text-teal-200 dark:text-teal-900/40 text-9xl absolute -top-5 -right-5 opacity-50 animate-float" style="animation-duration: 7s;"></i>

            <i class="ph ph-stethoscope text-teal-200 dark:text-teal-900/40 text-9xl absolute -bottom-8 -left-8 opacity-40 animate-float" style="animation-delay: 1.5s;"></i>

            <i class="ph ph-pill text-teal-300 dark:text-teal-800/30 text-4xl absolute top-1/3 right-10 opacity-30 animate-bounce-slow"></i>
            <i class="ph ph-pill text-teal-300 dark:text-teal-800/30 text-5xl absolute bottom-1/3 left-10 opacity-30 animate-bounce-slow" style="animation-delay: 0.5s; transform: rotate(45deg);"></i>

            <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-teal-300/20 dark:bg-teal-500/10 rounded-full blur-3xl"></div>
        </div>

        <div class="relative z-10 w-full max-w-md px-4 py-8">
            <div class="bg-white/80 dark:bg-slate-800/90 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-white/50 dark:border-slate-700 text-center transition-colors duration-300">
                <div class="w-16 h-16 bg-teal-100 dark:bg-teal-900/50 text-teal-600 dark:text-teal-400 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="ph ph-user-plus text-3xl"></i>
                </div>

                <h2 class="text-3xl font-bold mb-2 text-slate-800 dark:text-white">Join HealthPlus</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm">Create an account to track orders and save prescriptions.</p>

                <form id="register-form" class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Full Name</label>
                        <div class="relative">
                            <i class="ph ph-user absolute left-3 top-3 text-slate-400 text-lg"></i>
                            <input name="name" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition dark:text-white" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Email Address</label>
                        <div class="relative">
                            <i class="ph ph-envelope absolute left-3 top-3 text-slate-400 text-lg"></i>
                            <input name="email" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition dark:text-white" placeholder="name@example.com" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Password</label>
                        <div class="relative">
                            <i class="ph ph-lock-key absolute left-3 top-3 text-slate-400 text-lg"></i>
                            <input name="password" type="password" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition dark:text-white" placeholder="Create a strong password" required>
                        </div>
                        <div class="flex gap-1 mt-2 h-1">
                            <div class="w-1/4 bg-red-400 rounded-full"></div>
                            <div class="w-1/4 bg-slate-200 dark:bg-slate-600 rounded-full"></div>
                            <div class="w-1/4 bg-slate-200 dark:bg-slate-600 rounded-full"></div>
                            <div class="w-1/4 bg-slate-200 dark:bg-slate-600 rounded-full"></div>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Must contain 8+ characters, 1 number, 1 symbol.</p>
                    </div>

                    <div class="pt-2">
                        <button class="w-full bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 text-white py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 transform transition hover:-translate-y-0.5">Create Account</button>
                    </div>
                </form>

                <p class="mt-6 text-slate-600 dark:text-slate-400">
                    Already have an account? <button onclick="showPage('page-login')" class="text-teal-600 dark:text-teal-400 font-bold hover:underline">Sign In</button>
                </p>
            </div>
        </div>
    </div>

    <!-- NEW USER PROFILE SECTION -->
    <div id="page-profile" class="page hidden container mx-auto px-4 py-8 fade-in">
        <div class="flex flex-col md:flex-row gap-8">
            <aside class="w-full md:w-64 flex-shrink-0">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-teal-100 dark:bg-teal-900 rounded-full flex items-center justify-center mx-auto text-teal-600 dark:text-teal-400 text-3xl font-bold mb-3">
                            <i class="ph ph-user"></i>
                        </div>
                        <h3 id="profile-name-display" class="font-bold text-slate-800 dark:text-white">User Name</h3>
                        <p id="profile-email-display" class="text-sm text-slate-500 dark:text-slate-400 break-words">user@example.com</p>
                    </div>
                    <nav class="space-y-2">
                        <button onclick="switchProfileTab('orders')" id="btn-profile-orders" class="profile-tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 font-medium">
                            <i class="ph ph-package"></i> My Orders
                        </button>
                        <button onclick="switchProfileTab('favorites')" id="btn-profile-favorites" class="profile-tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">
                            <i class="ph ph-heart"></i> Favorites
                        </button>
                        <button onclick="switchProfileTab('addresses')" id="btn-profile-addresses" class="profile-tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">
                            <i class="ph ph-user-list"></i> Info & Addresses
                        </button>
                        <button onclick="switchProfileTab('wallet')" id="btn-profile-wallet" class="profile-tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">
                            <i class="ph ph-credit-card"></i> Wallet
                        </button>
                        <button onclick="logout()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                            <i class="ph ph-sign-out"></i> Logout
                        </button>
                    </nav>
                </div>
            </aside>

            <div class="flex-grow">
                <div id="profile-tab-orders" class="profile-tab-content">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Order History</h2>
                    <div id="orders-list" class="space-y-4"></div>
                </div>

                <div id="profile-tab-favorites" class="profile-tab-content hidden">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">My Favorites</h2>
                    <div id="favorites-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="profile-tab-addresses" class="profile-tab-content hidden">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">My Information</h2>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 mb-8 shadow-sm">
                        <h3 class="font-bold text-teal-600 dark:text-teal-400 mb-4 flex items-center gap-2"><i class="ph ph-identification-card"></i> Personal Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Full Name</label>
                                <input id="info-name-input" type="text" value="User Name" disabled class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300 cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Email Address</label>
                                <input id="info-email-input" type="text" value="email@example.com" disabled class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300 cursor-not-allowed">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm h-full">
                                <h3 class="font-bold text-teal-600 dark:text-teal-400 mb-4 flex items-center gap-2"><i class="ph ph-phone"></i> Mobile Number</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">This number will be used for all order communications.</p>
                                <div class="space-y-3">
                                    <input id="user-global-phone" type="tel" placeholder="+20 1xx xxx xxxx" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-teal-500 dark:text-white outline-none transition">
                                    <button onclick="saveGlobalPhone()" class="w-full bg-teal-600 text-white py-2 rounded-lg font-bold hover:bg-teal-700 transition shadow-lg shadow-teal-500/20">Update Phone</button>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg dark:text-white">Saved Addresses</h3>
                                <button onclick="toggleAddressForm()" class="text-xs bg-teal-600 text-white px-3 py-2 rounded-lg hover:bg-teal-700 flex items-center gap-1"><i class="ph ph-plus"></i> Add New</button>
                            </div>

                            <div id="new-address-form" class="hidden bg-white dark:bg-slate-800 p-6 rounded-xl border border-teal-200 dark:border-teal-900 mb-6 animate-fade-in shadow-glow">
                                <h4 class="font-bold mb-4 dark:text-white text-sm">New Delivery Location</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <input id="new-addr-label" placeholder="Label (e.g. Home, Office)" class="p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm">
                                    <select id="new-addr-gov" class="p-3 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm">
                                        <option value="" disabled selected>Select Governorate</option>
                                    </select>
                                </div>
                                <input id="new-addr-text" placeholder="Street Name, Building No, Apt..." class="w-full p-3 border rounded-lg mb-4 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm">
                                <div class="flex gap-2 justify-end">
                                    <button onclick="toggleAddressForm()" class="bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-white px-4 py-2 rounded-lg text-sm">Cancel</button>
                                    <button onclick="saveNewAddress()" class="bg-teal-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md">Save Address</button>
                                </div>
                            </div>

                            <div id="saved-addresses-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>

                <div id="profile-tab-wallet" class="profile-tab-content hidden">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Payment Options</h2>
                    <div class="grid gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
                            <h3 class="font-bold mb-4 dark:text-white">Digital Wallets</h3>
                            <div class="flex gap-4">
                                <button class="flex items-center gap-2 bg-black text-white px-6 py-3 rounded-xl hover:opacity-80">
                                    <i class="ph ph-apple-logo text-xl"></i> Apple Pay
                                </button>
                                <button class="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 px-6 py-3 rounded-xl hover:bg-slate-50">
                                    <i class="ph ph-google-logo text-xl text-red-500"></i> Google Pay
                                </button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold dark:text-white">Saved Cards</h3>
                                <button onclick="document.getElementById('new-card-form').classList.toggle('hidden')" class="text-sm text-teal-600 hover:underline">+ Add Card</button>
                            </div>
                            <div id="new-card-form" class="hidden bg-slate-50 dark:bg-slate-700 p-4 rounded-xl mb-4 animate-fade-in">
                                <input id="p-card-num" placeholder="Card Number" class="w-full p-2 mb-2 border rounded dark:bg-slate-800 dark:border-slate-600 dark:text-white">
                                <div class="flex gap-2 mb-2">
                                    <input id="p-card-exp" placeholder="MM/YY" class="w-1/2 p-2 border rounded dark:bg-slate-800 dark:border-slate-600 dark:text-white">
                                    <input id="p-card-cvc" placeholder="CVV" class="w-1/2 p-2 border rounded dark:bg-slate-800 dark:border-slate-600 dark:text-white">
                                </div>
                                <button onclick="saveNewCard()" class="bg-teal-600 text-white px-4 py-2 rounded text-sm">Save Card</button>
                            </div>
                            <div id="saved-cards-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ADMIN DASHBOARD -->
    <div id="page-admin-dashboard" class="page hidden w-full h-[calc(100vh-80px)] fade-in">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 hidden md:flex flex-col h-full shadow-sm z-10">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Admin Menu</div>
                    <nav class="space-y-1">
                        <button onclick="switchAdminTab('overview')" id="tab-btn-overview" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium flex items-center gap-3 transition bg-primary-50 text-primary-700 dark:bg-teal-900/30 dark:text-teal-400">
                            <i class="ph ph-chart-pie-slice text-xl"></i> Overview
                        </button>
                        <button onclick="switchAdminTab('products')" id="tab-btn-products" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 transition">
                            <i class="ph ph-package text-xl"></i> Products
                        </button>
                        <button onclick="switchAdminTab('orders')" id="tab-btn-orders" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 transition">
                            <i class="ph ph-shopping-cart text-xl"></i> Orders
                        </button>
                        <button onclick="switchAdminTab('users')" id="tab-btn-users" class="admin-tab-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3 transition">
                            <i class="ph ph-users text-xl"></i> Users
                        </button>
                    </nav>
                </div>
                <div class="p-6 mt-auto"><button onclick="logout()" class="w-full border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-50 dark:hover:bg-red-900/20"><i class="ph ph-sign-out"></i> Logout</button></div>
            </aside>

            <!-- Admin Content -->
            <div class="flex-grow bg-slate-50 dark:bg-slate-900 overflow-y-auto p-6 md:p-10 relative">

                <!-- TAB: OVERVIEW (With Graphs) -->
                <div id="admin-tab-overview" class="admin-tab-content space-y-8">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Dashboard Overview</h2>
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 rounded-full flex items-center justify-center text-2xl"><i class="ph ph-currency-dollar"></i></div>
                            <div><div class="text-sm text-slate-500 dark:text-slate-400">Total Sales</div><div class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-sales">$0.00</div></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center text-2xl"><i class="ph ph-users"></i></div>
                            <div><div class="text-sm text-slate-500 dark:text-slate-400">Total Users</div><div class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-users">0</div></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4">
                            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400 rounded-full flex items-center justify-center text-2xl"><i class="ph ph-shopping-bag"></i></div>
                            <div><div class="text-sm text-slate-500 dark:text-slate-400">Total Orders</div><div class="text-2xl font-bold text-slate-800 dark:text-white" id="stat-orders-count">0</div></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-4">
                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-400 rounded-full flex items-center justify-center text-2xl"><i class="ph ph-eye"></i></div>
                            <div><div class="text-sm text-slate-500 dark:text-slate-400">Site Visits</div><div class="text-2xl font-bold text-slate-800 dark:text-white">1,245</div></div>
                        </div>
                    </div>

                    <!-- Stock Alerts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold mb-4 flex items-center gap-2 dark:text-white"><i class="ph ph-warning text-yellow-500 text-xl"></i> Low Stock Alerts (<10)</h3>
                            <div id="admin-low-stock-list" class="space-y-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold mb-4 flex items-center gap-2 dark:text-white"><i class="ph ph-prohibit text-red-500 text-xl"></i> Out of Stock (0)</h3>
                            <div id="admin-out-stock-list" class="space-y-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Graphs -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 h-80">
                            <h3 class="font-bold mb-4 dark:text-white">Sales Breakdown (By Category)</h3>
                            <canvas id="chart-sales"></canvas>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 h-80">
                            <h3 class="font-bold mb-4 dark:text-white">Order Status</h3>
                            <canvas id="chart-orders"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TAB: PRODUCTS -->
                <div id="admin-tab-products" class="admin-tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Products</h2>
                        <button onclick="openProductModal()" class="px-5 py-2.5 bg-primary-600 text-white rounded-lg text-sm font-bold shadow-md flex items-center gap-2"><i class="ph ph-plus"></i> Add</button>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4 flex gap-4 flex-wrap">
                        <input id="filter-prod-name" placeholder="Search Name..." class="border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runProductFilter()">
                        <input id="filter-prod-price-min" type="number" placeholder="Min Price" class="border p-2 rounded text-sm w-24 dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runProductFilter()">
                        <input id="filter-prod-price-max" type="number" placeholder="Max Price" class="border p-2 rounded text-sm w-24 dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runProductFilter()">
                        <input id="filter-prod-stock" type="number" placeholder="Min Stock" class="border p-2 rounded text-sm w-24 dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runProductFilter()">
                    </div>
                    <div id="admin-products-table" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"></div>
                </div>

                <!-- TAB: ORDERS -->
                <div id="admin-tab-orders" class="admin-tab-content hidden">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Orders</h2>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4 flex gap-4 flex-wrap items-center">
                        <input id="filter-order-search" placeholder="Order ID or User..." class="border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runOrderFilter()">
                        <select id="filter-order-status" class="border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" onchange="runOrderFilter()">
                            <option value="">All Status</option>
                            <option value="Processing">Processing</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <!-- Payment Method Filter -->
                        <select id="filter-order-payment" class="border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" onchange="runOrderFilter()">
                            <option value="">All Payment Types</option>
                            <option value="cash">Cash</option>
                            <option value="credit">Credit Card</option>
                            <option value="apple">Apple Pay</option>
                            <option value="google">Google Pay</option>
                        </select>
                        <select id="filter-order-sort" class="border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" onchange="runOrderFilter()">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="total-desc">Highest Total</option>
                            <option value="total-asc">Lowest Total</option>
                        </select>
                    </div>
                    <div id="admin-orders-table" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"></div>
                </div>

                <!-- TAB: USERS -->
                <div id="admin-tab-users" class="admin-tab-content hidden">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Users</h2>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-4">
                        <input id="filter-user-search" placeholder="Search Name or Email..." class="border p-2 rounded text-sm w-full md:w-1/2 dark:bg-slate-700 dark:border-slate-600 dark:text-white" oninput="runUserFilter()">
                    </div>
                    <div id="admin-users-table" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="page-admin-login" class="page hidden max-w-sm mx-auto px-4 mt-20 fade-in">
        <div class="bg-slate-800 dark:bg-slate-700 text-white p-8 rounded-xl shadow-2xl text-center">
            <h2 class="text-xl font-bold mb-4">Admin Access</h2>
            <form id="admin-login-form" class="space-y-4">
                <input name="admin-id" placeholder="Admin ID" class="w-full p-2 bg-slate-700 dark:bg-slate-600 border-none rounded text-white" required>
                <input name="password" type="password" placeholder="Password" class="w-full p-2 bg-slate-700 dark:bg-slate-600 border-none rounded text-white" required>
                <button class="w-full bg-red-600 py-2 rounded font-bold">Login</button>
            </form>
        </div>
    </div>

    <!-- ORDERS PAGE -->
    <div id="page-orders" class="page hidden container mx-auto px-4 py-12 fade-in">
        <!-- This will now be handled inside Profile but kept here for compatibility/redirect -->
    </div>

</main>

<!-- FOOTER -->
<footer class="bg-slate-900 text-slate-300 py-12 mt-auto border-t dark:border-slate-800">
    <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-4 gap-8 mb-8">
            <div>
                <div class="flex items-center gap-2 mb-4 text-white">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-teal-500">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    <span class="text-xl font-bold">HealthPlus</span>
                </div>
                <p class="text-sm leading-relaxed text-slate-400">
                    Your trusted partner in health. We provide the best medicines and care products.
                </p>
            </div>
            <div>
                <h4 class="text-white font-bold mb-4">Quick Links</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" onclick="showPage('page-about')" class="hover:text-teal-400 transition-colors">About Us</a></li>
                    <li><a href="#" onclick="showPage('page-contact')" class="hover:text-teal-400 transition-colors">Contact</a></li>
                    <li><a href="#" onclick="showPage('page-home')" class="hover:text-teal-400 transition-colors">Shop</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold mb-4">Location</h4>
                <ul class="space-y-3 text-sm">
                    <li class="flex items-center gap-2"><i class="ph ph-map-pin"></i> New Cairo, Egypt</li>
                    <li class="flex items-center gap-2"><i class="ph ph-phone"></i> +20 123 456 7890</li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold mb-4">Follow Us</h4>
                <div class="flex gap-4">
                    <a href="#" class="hover:text-teal-400 transition-colors"><i class="ph ph-facebook-logo text-2xl"></i></a>
                    <a href="#" class="hover:text-teal-400 transition-colors"><i class="ph ph-twitter-logo text-2xl"></i></a>
                    <a href="#" class="hover:text-teal-400 transition-colors"><i class="ph ph-instagram-logo text-2xl"></i></a>
                </div>
            </div>
        </div>
        <div class="border-t border-slate-800 pt-8 text-center text-sm text-slate-500">
            &copy; 2025 HealthPlus Pharmacy. All rights reserved.
        </div>
    </div>
</footer>

<!-- MODALS -->

<!-- Upload Prescription -->
<div id="upload-modal" class="hidden fixed inset-0 bg-black/50 dark:bg-black/70 z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
    <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 relative shadow-2xl">
        <button onclick="document.getElementById('upload-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="ph ph-x text-2xl"></i></button>
        <h2 class="text-2xl font-bold text-center mb-4 dark:text-white">Upload Rx</h2>
        <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 mb-6 text-center hover:border-teal-500 dark:hover:border-teal-400 cursor-pointer bg-slate-50 dark:bg-slate-700">
            <p class="dark:text-slate-300">Click to upload JPG/PDF</p>
        </div>
        <button onclick="showToast('Uploaded!'); document.getElementById('upload-modal').classList.add('hidden');" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold">Submit</button>
    </div>
</div>

<!-- Admin Product Modal -->
<div id="product-modal" class="hidden fixed inset-0 bg-black/60 dark:bg-black/80 z-[90] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-md m-4">
        <h3 id="modal-title" class="text-xl font-bold mb-4 dark:text-white">Product</h3>
        <form id="admin-prod-form" class="space-y-3">
            <input type="hidden" id="prod-id">
            <input id="prod-name" placeholder="Name" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded" required>
            <div class="flex gap-2"><select id="prod-cat" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded"></select><button type="button" onclick="promptCat()" class="bg-green-100 text-green-700 px-3 rounded">+</button></div>
            <div class="flex gap-2"><input id="prod-price" type="number" step="0.01" placeholder="Price" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded" required><input id="prod-stock" type="number" placeholder="Stock" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded" required></div>
            <textarea id="prod-desc" placeholder="Desc" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded h-20"></textarea>
            <input id="prod-img" placeholder="Image URL" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded">
            <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('product-modal').classList.add('hidden')" class="px-4 py-2 border dark:border-slate-600 dark:text-white rounded">Cancel</button><button class="px-4 py-2 bg-teal-600 text-white rounded">Save</button></div>
        </form>
    </div>
</div>

<!-- Admin Order Details Modal -->
<div id="admin-order-modal" class="hidden fixed inset-0 bg-black/60 dark:bg-black/80 z-[90] flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg m-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold dark:text-white">Order Details</h3>
            <button onclick="document.getElementById('admin-order-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button>
        </div>
        <div id="admin-order-content" class="space-y-4 text-sm dark:text-slate-200">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<!-- Admin User Details Modal -->
<div id="admin-user-modal" class="hidden fixed inset-0 bg-black/60 dark:bg-black/80 z-[90] flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg m-4">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold dark:text-white">User Details</h3>
            <button onclick="document.getElementById('admin-user-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button>
        </div>
        <div id="admin-user-content" class="space-y-4 text-sm dark:text-slate-200">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<!-- Cart Modal (Centered) - UPGRADED FOR CHECKOUT -->
<div id="cart-modal" class="hidden fixed inset-0 bg-black/50 dark:bg-black/70 z-[80] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
    <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg p-6 relative shadow-2xl max-h-[95vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h3 class="font-bold text-xl dark:text-white">Your Cart</h3>
            <button onclick="toggleCart()" class="text-slate-400 hover:text-red-500"><i class="ph ph-x text-2xl"></i></button>
        </div>

        <div id="cart-items" class="flex-grow overflow-y-auto p-2 space-y-4"></div>

        <div class="pt-4 border-t dark:border-slate-700 mt-4 flex-shrink-0">
            <div class="flex justify-between text-lg font-bold mb-4"><span class="dark:text-white">Total</span><span id="cart-total" class="text-teal-600 dark:text-teal-400">$0.00</span></div>

            <!-- CHECKOUT FORM -->
            <div id="checkout-form-container" class="hidden space-y-4 mb-3 max-h-[50vh] overflow-y-auto pr-2">
                <!-- 1. Address Section -->
                <div>
                    <label class="block text-sm font-bold mb-2 dark:text-white">Delivery Address</label>
                    <div id="checkout-address-selector" class="space-y-2 mb-2">
                        <!-- Dynamically filled with saved addresses -->
                    </div>
                    <!-- New Address Fields (Toggleable) -->
                    <div id="checkout-new-address" class="space-y-2">
                        <select id="chk-gov" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded">
                            <option value="" disabled selected>Select Governorate</option>
                            <!-- Injected via JS -->
                        </select>
                        <input id="chk-addr" placeholder="Street Address" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded">
                        <input id="chk-phone" placeholder="Phone Number" class="w-full p-2 border dark:bg-slate-700 dark:border-slate-600 dark:text-white rounded">
                    </div>
                </div>

                <!-- 2. Payment Section -->
                <div>
                    <label class="block text-sm font-bold mb-2 dark:text-white">Payment Method</label>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <label class="border dark:border-slate-600 rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                            <input type="radio" name="paymethod" value="cash" checked onchange="togglePaymentFields()"> <span class="dark:text-white text-sm">Cash</span>
                        </label>
                        <label class="border dark:border-slate-600 rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                            <input type="radio" name="paymethod" value="credit" onchange="togglePaymentFields()"> <span class="dark:text-white text-sm">Credit Card</span>
                        </label>
                        <label class="border dark:border-slate-600 rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                            <input type="radio" name="paymethod" value="apple" onchange="togglePaymentFields()"> <span class="dark:text-white text-sm">Apple Pay</span>
                        </label>
                        <label class="border dark:border-slate-600 rounded p-2 flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                            <input type="radio" name="paymethod" value="google" onchange="togglePaymentFields()"> <span class="dark:text-white text-sm">Google Pay</span>
                        </label>
                    </div>

                    <!-- Credit Card Section Container -->
                    <div id="credit-card-section" class="hidden space-y-2 bg-slate-50 dark:bg-slate-700 p-3 rounded-lg border dark:border-slate-600">
                        <!-- Saved Cards Selector (Injected via JS) -->
                        <div id="checkout-saved-cards" class="space-y-2 mb-2"></div>

                        <!-- New Card Inputs -->
                        <div id="card-inputs" class="space-y-2">
                            <input id="chk-card-name" placeholder="Cardholder Name" class="w-full p-2 border dark:bg-slate-800 dark:border-slate-500 dark:text-white rounded text-sm">
                            <input id="chk-card" placeholder="Card Number (0000 0000 0000 0000)" class="w-full p-2 border dark:bg-slate-800 dark:border-slate-500 dark:text-white rounded text-sm">
                            <div class="flex gap-2">
                                <input id="chk-card-exp" placeholder="MM/YY" class="w-1/2 p-2 border dark:bg-slate-800 dark:border-slate-500 dark:text-white rounded text-sm">
                                <input id="chk-card-cvc" placeholder="CVV" class="w-1/2 p-2 border dark:bg-slate-800 dark:border-slate-500 dark:text-white rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Wallet Info -->
                    <div id="wallet-info" class="hidden text-center p-4 bg-slate-100 dark:bg-slate-700 rounded text-sm dark:text-white">
                        Redirecting to secure payment gateway...
                    </div>
                </div>
            </div>

            <button id="btn-checkout" onclick="showCheckout()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 hover:bg-teal-700 transition">Proceed to Checkout</button>
            <button id="btn-confirm" onclick="placeOrder()" class="hidden w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 hover:bg-green-700 transition">Confirm Order</button>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receipt-modal" class="hidden fixed inset-0 bg-black/50 dark:bg-black/70 z-[90] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full relative">
        <button onclick="document.getElementById('receipt-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-200"><i class="ph ph-x text-2xl"></i></button>
        <div class="text-center mb-6">
            <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i class="ph ph-check text-3xl"></i></div>
            <h2 class="text-2xl font-bold dark:text-white">Order Confirmed!</h2>
            <p class="text-slate-500 dark:text-slate-400" id="rcpt-date"></p>
        </div>
        <div class="space-y-2 text-sm border-t border-b dark:border-slate-700 py-4 my-2 dark:text-slate-300">
            <div class="flex justify-between"><span>Order ID:</span><span class="font-bold" id="rcpt-id"></span></div>
            <div class="flex justify-between"><span>Status:</span><span class="font-bold text-green-600 dark:text-green-400" id="rcpt-status">Processing</span></div>
            <div class="flex justify-between"><span>Payment:</span><span class="font-bold uppercase" id="rcpt-pay"></span></div>
            <div class="flex justify-between"><span>Phone:</span><span class="font-bold" id="rcpt-phone"></span></div>
            <div class="flex flex-col mt-2">
                <span class="text-xs text-slate-500">Delivered To:</span>
                <span class="font-bold text-sm" id="rcpt-addr"></span>
            </div>
            <div class="mt-2 font-bold">Items:</div>
            <div id="rcpt-items" class="pl-2 text-slate-600 dark:text-slate-400 text-xs"></div>
        </div>
        <div class="flex justify-between text-xl font-bold mt-4 dark:text-white"><span>Total:</span><span id="rcpt-total"></span></div>
        <button onclick="document.getElementById('receipt-modal').classList.add('hidden')" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold mt-6">Close</button>
    </div>
</div>


<script>
    // --- GLOBAL STATE ---
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let savedAddresses = JSON.parse(localStorage.getItem('savedAddresses')) || [];
    let savedCards = JSON.parse(localStorage.getItem('savedCards')) || [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

    // Global Phone storage
    let userGlobalPhone = localStorage.getItem('userGlobalPhone') || "";

    const governorates = ["Cairo", "Giza", "Alexandria", "Dakahlia", "Red Sea", "Beheira", "Fayoum", "Gharbiya", "Ismailia", "Monufia", "Minya", "Qaliubiya", "New Valley", "Suez", "Aswan", "Assiut", "Beni Suef", "Port Said", "Damietta", "Sharkia", "South Sinai", "Kafr Al sheikh", "Matrouh", "Luxor", "Qena", "North Sinai", "Sohag"];

    let allProducts = [];
    let adminProductsData = [];
    let adminOrdersData = [];
    let adminUsersData = [];
    let charts = {};

    // --- API & UTILS ---
    const api = async (url, method='GET', body=null) => {
        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        try {
            const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
            return await res.json();
        } catch (e) { showToast("Connection Error", "error"); return null; }
    };

    function showToast(msg, type='success') {
        const box = document.createElement('div');
        let bgClass = type === 'success' ? 'bg-slate-800 dark:bg-slate-700' : type === 'error' ? 'bg-red-600' : 'bg-yellow-600 text-white';
        let iconClass = type === 'success' ? 'ph-check-circle' : 'ph-warning-circle';

        box.className = `flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl text-white text-sm font-bold animate-fade-in ${bgClass}`;
        box.innerHTML = `<i class="ph ${iconClass} text-xl"></i> ${msg}`;

        const container = document.getElementById('toast-container');
        if(container) {
            container.appendChild(box);
            setTimeout(() => box.remove(), 3000);
        }
    }

    // --- DARK MODE LOGIC ---
    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
        const isDark = document.documentElement.classList.contains('dark');
        const icon = document.getElementById('dark-mode-icon');
        if(icon) {
            icon.className = isDark ? 'ph ph-sun text-2xl text-yellow-400' : 'ph ph-moon text-2xl';
        }
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }

    // --- NAVIGATION & AUTH CHECK ---
    function checkAuth() {
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole');

        const elGuest = document.getElementById('nav-guest');
        if(elGuest) elGuest.classList.toggle('hidden', !!token);

        const elUser = document.getElementById('nav-user');
        if(elUser) elUser.classList.toggle('hidden', !(token && role === 'user'));

        const elAdmin = document.getElementById('nav-admin');
        if(elAdmin) elAdmin.classList.toggle('hidden', !(token && role === 'admin'));

        const elMobile = document.getElementById('mobile-auth-links');
        if(elMobile) elMobile.classList.toggle('hidden', !!token);

        const elContact = document.getElementById('nav-contact-link');
        if(elContact) elContact.classList.toggle('hidden', role === 'admin');

        updateCartBadge();
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');

        const main = document.getElementById('main-container');
        if(id === 'page-admin-dashboard') {
            main.classList.remove('container', 'mx-auto', 'px-4');
            loadAdminStats();
        } else {
            main.classList.add('container', 'mx-auto', 'px-4');
        }

        document.getElementById('hero-section').classList.toggle('hidden', id !== 'page-home');
        window.scrollTo(0,0);

        if (id === 'page-home') {
            main.classList.remove('container', 'mx-auto', 'px-4');
            loadCategories();
        }
        if (id === 'page-orders') loadUserOrders();
        if (id === 'page-profile') loadProfile();
    }

    function logout() {
        localStorage.clear();
        cart = []; favorites = [];
        checkAuth();
        showPage('page-home');
        showToast("Logged out");
    }

    // --- PROFILE LOGIC (UPDATED) ---
    function switchProfileTab(tab) {
        document.querySelectorAll('.profile-tab-content').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById(`profile-tab-${tab}`);
        if(target) target.classList.remove('hidden');

        document.querySelectorAll('.profile-tab-btn').forEach(btn => {
            btn.classList.remove('bg-teal-50', 'text-teal-700', 'dark:bg-teal-900/30', 'dark:text-teal-400');
            btn.classList.add('text-slate-600', 'dark:text-slate-300');
        });
        const active = document.getElementById(`btn-profile-${tab}`);
        if(active) {
            active.classList.remove('text-slate-600', 'dark:text-slate-300');
            active.classList.add('bg-teal-50', 'text-teal-700', 'dark:bg-teal-900/30', 'dark:text-teal-400');
        }

        if(tab === 'favorites') loadFavoritesGrid();
    }

    function loadProfile() {
        switchProfileTab('orders');
        loadUserOrders();
        renderAddresses();
        renderSavedCards();

        // 1. Fill Info Fields (Name/Email)
        const email = localStorage.getItem('userEmail') || 'user@example.com';
        const name = localStorage.getItem('userName') || 'User Name'; // Mock name if not in storage

        // Sidebar
        const displayEmail = document.getElementById('profile-email-display');
        const displayName = document.getElementById('profile-name-display');
        if(displayEmail) displayEmail.innerText = email;
        if(displayName) displayName.innerText = name;

        // Info Inputs
        const inputName = document.getElementById('info-name-input');
        const inputEmail = document.getElementById('info-email-input');
        if(inputName) inputName.value = name;
        if(inputEmail) inputEmail.value = email;

        // 2. Fill Global Phone
        userGlobalPhone = localStorage.getItem('userGlobalPhone') || '';
        const phoneInput = document.getElementById('user-global-phone');
        if(phoneInput) phoneInput.value = userGlobalPhone;

        // Populate Gov Selects
        const govOptions = `<option value="" disabled selected>Select Governorate</option>` + governorates.map(g => `<option value="${g}">${g}</option>`).join('');
        const g1 = document.getElementById('new-addr-gov');
        const g2 = document.getElementById('chk-gov');
        if(g1) g1.innerHTML = govOptions;
        if(g2) g2.innerHTML = govOptions;
    }

    function saveGlobalPhone() {
        const phone = document.getElementById('user-global-phone').value;
        if(!phone) return showToast("Please enter a phone number", "error");

        localStorage.setItem('userGlobalPhone', phone);
        userGlobalPhone = phone;
        showToast("Phone Number Updated!");
    }

    function renderAddresses() {
        const list = document.getElementById('saved-addresses-list');
        if(savedAddresses.length === 0) {
            list.innerHTML = `<div class="col-span-full text-center p-6 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-slate-400 text-sm border border-dashed border-slate-300 dark:border-slate-600">No addresses saved.</div>`;
            return;
        }
        // Removed phone display from here
        list.innerHTML = savedAddresses.map((addr, idx) => `
            <div class="border dark:border-slate-700 p-4 rounded-xl relative hover:shadow-md transition bg-white dark:bg-slate-700 group">
                <button onclick="removeAddress(${idx})" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 transition"><i class="ph ph-trash text-lg"></i></button>
                <div class="flex items-center gap-2 mb-2">
                    <i class="ph ph-map-pin text-teal-600 dark:text-teal-400"></i>
                    <span class="font-bold text-slate-800 dark:text-white text-sm">${addr.label}</span>
                </div>
                <div class="pl-6">
                    <div class="text-xs text-slate-500 dark:text-slate-300 font-semibold bg-slate-100 dark:bg-slate-600 inline-block px-2 py-0.5 rounded mb-1">${addr.gov}</div>
                    <div class="text-sm text-slate-600 dark:text-slate-200 leading-snug">${addr.text}</div>
                </div>
            </div>
        `).join('');
    }

    function toggleAddressForm() {
        document.getElementById('new-address-form').classList.toggle('hidden');
    }

    function saveNewAddress() {
        const label = document.getElementById('new-addr-label').value;
        const gov = document.getElementById('new-addr-gov').value;
        const text = document.getElementById('new-addr-text').value;

        // Removed phone validation since it's separate now
        if(!label || !text || !gov) return showToast("Please fill address details", "error");

        savedAddresses.push({ label, text, gov });
        localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
        renderAddresses();
        toggleAddressForm();

        document.getElementById('new-addr-label').value = '';
        document.getElementById('new-addr-text').value = '';
        document.getElementById('new-addr-gov').value = '';
    }

    function removeAddress(idx) {
        if(confirm("Delete this address?")) {
            savedAddresses.splice(idx, 1);
            localStorage.setItem('savedAddresses', JSON.stringify(savedAddresses));
            renderAddresses();
        }
    }

    function renderSavedCards() {
        const list = document.getElementById('saved-cards-list');
        if(savedCards.length === 0) {
            list.innerHTML = `<div class="text-slate-400 text-sm">No cards saved.</div>`;
            return;
        }
        list.innerHTML = savedCards.map((card, idx) => `
            <div class="flex justify-between items-center border dark:border-slate-700 p-3 rounded-lg bg-white dark:bg-slate-700">
                <div class="flex items-center gap-3">
                    <i class="ph ph-credit-card text-2xl text-teal-600"></i>
                    <div>
                        <div class="text-sm font-bold dark:text-white">•••• ${card.last4}</div>
                        <div class="text-xs text-slate-500">Exp: ${card.exp}</div>
                    </div>
                </div>
                <button onclick="removeCard(${idx})" class="text-red-400 hover:text-red-600 text-sm">Remove</button>
            </div>
        `).join('');
    }

    function saveNewCard() {
        const num = document.getElementById('p-card-num').value;
        const exp = document.getElementById('p-card-exp').value;
        if(!num || !exp) return showToast("Invalid Card Details", "error");

        savedCards.push({ last4: num.slice(-4), exp });
        localStorage.setItem('savedCards', JSON.stringify(savedCards));
        renderSavedCards();
        document.getElementById('new-card-form').classList.add('hidden');
        document.getElementById('p-card-num').value = '';
    }

    function removeCard(idx) {
        savedCards.splice(idx, 1);
        localStorage.setItem('savedCards', JSON.stringify(savedCards));
        renderSavedCards();
    }

    // --- SHOP & PRODUCTS ---
    async function loadCategories() {
        const cats = await api('/api/categories');
        if(!cats) return;
        const container = document.getElementById('category-chips');
        const getIcon = (name) => {
            const n = name.toLowerCase();
            if(n.includes('baby')) return '<i class="ph ph-baby text-xl"></i>';
            if(n.includes('device')) return '<i class="ph ph-thermometer text-xl"></i>';
            if(n.includes('vitamin')) return '<i class="ph ph-heartbeat text-xl"></i>';
            return '<i class="ph ph-pill text-xl"></i>';
        };
        const allBtn = `<button onclick="loadProducts('All Products')" class="flex items-center gap-2 px-6 py-3 rounded-full whitespace-nowrap transition-all border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-teal-500 hover:text-teal-600 dark:hover:text-teal-400 bg-white dark:bg-slate-800"><i class="ph ph-squares-four text-xl"></i> <span class="font-medium">All</span></button>`;
        container.innerHTML = allBtn + cats.map(c => `<button onclick="loadProducts('${c.name}')" class="flex items-center gap-2 px-6 py-3 rounded-full whitespace-nowrap transition-all border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-teal-500 hover:text-teal-600 dark:hover:text-teal-400 bg-white dark:bg-slate-800">${getIcon(c.name)} <span class="font-medium">${c.name}</span></button>`).join('');
        loadProducts('All Products');
    }

    async function loadProducts(catName) {
        const title = document.getElementById('current-category-title');
        if(title) title.innerText = catName;
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '<div class="col-span-full flex justify-center py-20"><div class="loader"></div></div>';

        const data = await api(`/api/products?category=${catName}`);
        allProducts = data || [];
        renderProducts(allProducts);
    }

    function renderProducts(products, containerId = 'product-grid') {
        const grid = document.getElementById(containerId);
        if (!products || products.length === 0) {
            grid.innerHTML = '<div class="col-span-full text-center text-slate-400 dark:text-slate-500 py-10">No products found.</div>';
            return;
        }

        grid.innerHTML = products.map(p => {
            const isOutOfStock = p.stock === 0;
            const isFav = favorites.some(fid => fid == p.id);

            return `
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden hover:shadow-md transition-all group animate-fade-in relative">
                <button onclick="event.stopPropagation(); toggleFavorite(${p.id})" class="absolute top-3 right-3 z-30 p-2 rounded-full bg-white/80 dark:bg-slate-700/80 hover:bg-white dark:hover:bg-slate-600 transition shadow-sm backdrop-blur-sm">
                    <i class="${isFav ? 'ph-fill text-red-500' : 'ph text-slate-400 hover:text-red-500'} ph-heart text-xl"></i>
                </button>

                ${isOutOfStock ? `
                    <div class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none">
                        <span class="bg-slate-800/80 text-white px-6 py-2 rounded-full font-bold shadow-lg backdrop-blur-md">Out of Stock</span>
                    </div>
                ` : ''}

                <div class="${isOutOfStock ? 'blur-sm opacity-50' : ''} transition-all duration-300">
                    <div class="relative h-48 bg-slate-50 dark:bg-slate-700 flex items-center justify-center p-4">
                        <img src="${p.imageUrl || 'https://placehold.co/400'}" class="object-contain h-full w-full group-hover:scale-105 transition-transform duration-300">
                    </div>
                    <div class="p-4">
                        <div class="text-xs font-semibold text-teal-600 dark:text-teal-400 mb-1 uppercase tracking-wide">${p.category}</div>
                        <h3 class="font-bold text-slate-800 dark:text-white mb-2 truncate">${p.name}</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-slate-900 dark:text-white">$${p.price.toFixed(2)}</span>
                            <span class="text-xs text-slate-400">${p.stock} in stock</span>
                        </div>
                    </div>
                </div>

                <div class="px-4 pb-4 relative z-30">
                     <button onclick="${isOutOfStock ? `showToast('We will notify you when back in stock!');` : `addToCart(${p.id})`}"
                            class="w-full px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2
                            ${isOutOfStock ? 'bg-slate-200 text-slate-600 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300' : 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 hover:bg-teal-600 hover:text-white dark:hover:bg-teal-600'}">
                            ${isOutOfStock ? '<i class="ph ph-bell"></i> Notify Me' : 'Add to Cart'}
                    </button>
                </div>
            </div>`
        }).join('');
    }

    function filterProducts(query) { renderProducts(allProducts.filter(p => p.name.toLowerCase().includes(query.toLowerCase()))); }

    // --- FAVORITES LOGIC ---
    function toggleFavorite(id) {
        const numId = parseInt(id);
        const index = favorites.indexOf(numId);
        if (index > -1) { favorites.splice(index, 1); showToast("Removed from Favorites"); }
        else { favorites.push(numId); showToast("Added to Favorites"); }
        localStorage.setItem('favorites', JSON.stringify(favorites));

        if(!document.getElementById('page-home').classList.contains('hidden')) { renderProducts(allProducts, 'product-grid'); }
        if(!document.getElementById('profile-tab-favorites').classList.contains('hidden')) { loadFavoritesGrid(); }
    }

    async function loadFavoritesGrid() {
        const grid = document.getElementById('favorites-grid');
        grid.innerHTML = '<div class="col-span-full flex justify-center py-10"><div class="loader"></div></div>';
        if(favorites.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-slate-400">No favorites yet.</div>'; return; }
        if (allProducts.length === 0) { allProducts = await api(`/api/products`) || []; }
        const favProducts = allProducts.filter(p => favorites.includes(p.id));
        if (favProducts.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-slate-400">Items no longer available.</div>'; }
        else { renderProducts(favProducts, 'favorites-grid'); }
    }


    // --- CART LOGIC ---
    function toggleCart() {
        const modal = document.getElementById('cart-modal');
        const isOpen = !modal.classList.contains('hidden');
        if (isOpen) {
            modal.classList.add('hidden');
            document.getElementById('checkout-form-container').classList.add('hidden');
            document.getElementById('btn-checkout').classList.remove('hidden');
            document.getElementById('btn-confirm').classList.add('hidden');
        } else {
            if(!localStorage.getItem('authToken')) return showToast("Login to view cart", "error");
            modal.classList.remove('hidden');
            renderCart();
        }
    }

    function addToCart(id) {
        if(!localStorage.getItem('authToken')) return showToast("Please login first", "error");
        const prod = allProducts.find(p => p.id === id);
        if(!prod) return;
        if(prod.stock === 0) return showToast("Item out of stock", "error");

        const exists = cart.find(c => c.id === id);
        if(exists) {
            if(exists.quantity >= prod.stock) {
                return showToast(`Sorry! Only ${prod.stock} items left in stock.`, 'error');
            }
            exists.quantity++;
        } else {
            cart.push({ ...prod, quantity: 1 });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartBadge(); showToast("Added to cart");
    }

    function updateCartBadge() {
        const count = cart.reduce((a, b) => a + b.quantity, 0);
        const badge = document.getElementById('cart-badge');
        if(badge) {
            badge.innerText = count;
            badge.classList.toggle('opacity-0', count === 0);
        }
    }

    function renderCart() {
        const con = document.getElementById('cart-items');
        if(cart.length === 0) {
            con.innerHTML = `<div class="text-center text-slate-400 py-10">Cart is empty</div>`;
            document.getElementById('cart-total').innerText = "$0.00"; return;
        }
        let total = 0;
        con.innerHTML = cart.map(i => {
            total += i.price * i.quantity;
            const isMaxed = i.quantity >= i.stock;
            return `
            <div class="flex gap-3 mb-4 items-center animate-fade-in border-b dark:border-slate-700 pb-2">
                <img src="${i.imageUrl || 'https://placehold.co/100'}" class="w-14 h-14 rounded-lg bg-slate-100 dark:bg-slate-700 object-contain p-1">
                <div class="flex-grow">
                    <h4 class="font-bold text-sm text-slate-800 dark:text-white line-clamp-1">${i.name}</h4>
                    <div class="text-teal-600 dark:text-teal-400 font-bold text-sm">$${(i.price*i.quantity).toFixed(2)}</div>
                    <div class="text-[10px] text-slate-400">Available: ${i.stock}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="updateQty(${i.id}, -1)" class="w-6 h-6 bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-white flex items-center justify-center">-</button>
                    <span class="text-xs font-bold dark:text-white w-4 text-center">${i.quantity}</span>
                    <button onclick="updateQty(${i.id}, 1)"
                        class="w-6 h-6 rounded flex items-center justify-center transition-all
                        ${isMaxed ? 'bg-slate-50 text-slate-300 cursor-not-allowed' : 'bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-white'}">
                        +
                    </button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
    }

    function updateQty(id, chg) {
        const item = cart.find(c => c.id === id);
        if (item) {
            if(chg > 0 && item.quantity >= item.stock) {
                return showToast(`Cannot add more. Max stock is ${item.stock}`, 'error');
            }
            item.quantity += chg;
            if (item.quantity <= 0) cart = cart.filter(c => c.id !== id);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart(); updateCartBadge();
        }
    }

    // --- CHECKOUT ---
    function showCheckout() {
        document.getElementById('btn-checkout').classList.add('hidden');
        document.getElementById('btn-confirm').classList.remove('hidden');
        document.getElementById('checkout-form-container').classList.remove('hidden');

        const govOptions = `<option value="" disabled selected>Select Governorate</option>` + governorates.map(g => `<option value="${g}">${g}</option>`).join('');
        const chkGov = document.getElementById('chk-gov');
        if(chkGov) chkGov.innerHTML = govOptions;

        const selector = document.getElementById('checkout-address-selector');
        const newAddrDiv = document.getElementById('checkout-new-address');

        if(savedAddresses.length > 0) {
            newAddrDiv.classList.add('hidden');
            selector.innerHTML = savedAddresses.map((addr, i) => `
                <label class="block border dark:border-slate-600 rounded p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 mb-2">
                    <input type="radio" name="checkout_addr" value="${i}" ${i===0?'checked':''} onchange="toggleCheckoutAddr(this.value)">
                    <span class="font-bold text-sm ml-2 dark:text-white">${addr.label}</span>
                    <span class="text-xs text-slate-500 ml-2">${addr.gov}, ${addr.text}</span>
                </label>
            `).join('') + `
                <label class="block border border-dashed dark:border-slate-600 rounded p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 text-teal-600">
                    <input type="radio" name="checkout_addr" value="new" onchange="toggleCheckoutAddr(this.value)">
                    <span class="font-bold text-sm ml-2">+ Add New Address</span>
                </label>
            `;
        } else {
            selector.innerHTML = '';
            newAddrDiv.classList.remove('hidden');
        }
        togglePaymentFields();
    }

    function toggleCheckoutAddr(val) {
        const newAddrDiv = document.getElementById('checkout-new-address');
        if(val === 'new') {
            newAddrDiv.classList.remove('hidden');
        } else {
            newAddrDiv.classList.add('hidden');
        }
    }

    function togglePaymentFields() {
        const method = document.querySelector('input[name="paymethod"]:checked').value;
        const creditSection = document.getElementById('credit-card-section');
        const cardInputs = document.getElementById('card-inputs');
        const walletInfo = document.getElementById('wallet-info');
        const savedCardsContainer = document.getElementById('checkout-saved-cards');

        if(method === 'credit') {
            creditSection.classList.remove('hidden');
            walletInfo.classList.add('hidden');
            if (savedCards.length > 0) {
                savedCardsContainer.innerHTML = savedCards.map((card, i) => `
                    <label class="block border dark:border-slate-600 rounded p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 mb-2">
                        <input type="radio" name="checkout_card" value="${i}" ${i===0?'checked':''} onchange="toggleNewCardInput(this.value)">
                        <span class="font-bold text-sm ml-2 dark:text-white">•••• ${card.last4}</span>
                    </label>
                `).join('') + `
                    <label class="block border border-dashed dark:border-slate-600 rounded p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 text-teal-600">
                        <input type="radio" name="checkout_card" value="new" onchange="toggleNewCardInput(this.value)">
                        <span class="font-bold text-sm ml-2">+ Use New Card</span>
                    </label>
                `;
                cardInputs.classList.add('hidden');
            } else {
                savedCardsContainer.innerHTML = '';
                cardInputs.classList.remove('hidden');
            }
        } else if(method === 'apple' || method === 'google') {
            creditSection.classList.add('hidden');
            walletInfo.classList.remove('hidden');
        } else {
            creditSection.classList.add('hidden');
            walletInfo.classList.add('hidden');
        }
    }

    function toggleNewCardInput(val) {
        const cardInputs = document.getElementById('card-inputs');
        if(val === 'new') cardInputs.classList.remove('hidden'); else cardInputs.classList.add('hidden');
    }

    async function placeOrder() {
        let addr = '', phone = '', gov = '';

        // Determine Address
        const selectedAddrInput = document.querySelector('input[name="checkout_addr"]:checked');

        // Logic: if savedAddresses exist AND user picked one
        if(savedAddresses.length > 0 && selectedAddrInput && selectedAddrInput.value !== 'new') {
            const idx = parseInt(selectedAddrInput.value);
            const saved = savedAddresses[idx];
            if(saved) {
                addr = saved.text;
                gov = saved.gov;
                // USE GLOBAL PHONE FOR SAVED ADDRESSES
                phone = localStorage.getItem('userGlobalPhone');
            }
        } else {
            // New Address Fields
            gov = document.getElementById('chk-gov').value;
            addr = document.getElementById('chk-addr').value;
            phone = document.getElementById('chk-phone').value;
        }

        if(!phone) return showToast("Phone number required! Please check your profile.", "error");
        if(!addr || !gov) return showToast("Address and Governorate required", "error");

        const method = document.querySelector('input[name="paymethod"]:checked').value;
        let cardInfo = null;
        if(method === 'credit') {
            const selectedCardVal = document.querySelector('input[name="checkout_card"]:checked')?.value;
            if (selectedCardVal && selectedCardVal !== 'new' && savedCards.length > 0) {
                cardInfo = { savedCardIndex: selectedCardVal, last4: savedCards[parseInt(selectedCardVal)].last4 };
            } else {
                const num = document.getElementById('chk-card').value;
                const cvc = document.getElementById('chk-card-cvc').value;
                const exp = document.getElementById('chk-card-exp').value;
                if(!num || !cvc || !exp) return showToast("Incomplete Card Details", "error");
                cardInfo = { cardNumber: num, cvc, exp };
            }
        }

        const res = await api('/api/orders/create', 'POST', { cart, address: addr, gov, phone, paymentMethod: method, cardInfo, saveCard: false });
        if(res && res.success) {
            showToast("Order Placed!");
            document.getElementById('cart-modal').classList.add('hidden');
            cart=[]; localStorage.setItem('cart','[]'); updateCartBadge();
            showReceipt(res);
            loadCategories();
        }
        else showToast("Failed", "error");
    }

    function showReceipt(order) {
        document.getElementById('rcpt-id').innerText = '#' + order.id;
        document.getElementById('rcpt-date').innerText = new Date(order.date).toLocaleDateString();
        document.getElementById('rcpt-status').innerText = order.status || 'Processing';
        document.getElementById('rcpt-pay').innerText = order.paymentMethod || order.payment_method;
        document.getElementById('rcpt-total').innerText = '$' + (typeof order.total === 'number' ? order.total.toFixed(2) : order.total);
        document.getElementById('rcpt-phone').innerText = order.phone || 'N/A';
        document.getElementById('rcpt-addr').innerText = `${order.gov || ''} - ${order.address || ''}`;

        let items = order.items;
        if (typeof items === 'string') try { items = JSON.parse(items); } catch(e) {}

        document.getElementById('rcpt-items').innerHTML = (items || []).map(i => `<div class="flex justify-between"><span>${i.name} x${i.quantity}</span><span>$${(i.price*i.quantity).toFixed(2)}</span></div>`).join('');
        document.getElementById('receipt-modal').classList.remove('hidden');
    }

    // --- AUTH ---
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd);
        const res = await api('/api/login', 'POST', data);
        if (res.success) {
            localStorage.setItem('authToken', res.token);
            localStorage.setItem('userRole', 'user');
            localStorage.setItem('userEmail', data.email);
            // Save mock name
            localStorage.setItem('userName', 'User');
            checkAuth(); showPage('page-home'); showToast("Welcome!");
        } else showToast(res.message, 'error');
    };
    document.getElementById('register-form').onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd);
        const res = await api('/api/register', 'POST', data);
        if (res.success) { showToast("Created!"); showPage('page-login'); } else showToast(res.message, 'error');
    };
    document.getElementById('admin-login-form').onsubmit = async (e) => {
        e.preventDefault();
        const res = await api('/api/admin/login', 'POST', Object.fromEntries(new FormData(e.target)));
        if (res.success) { localStorage.setItem('authToken', res.token); localStorage.setItem('userRole', 'admin'); checkAuth(); showPage('page-admin-dashboard'); } else showToast("Denied", "error");
    };

    // --- ADMIN DASHBOARD ---
    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab-btn').forEach(b => {
            b.classList.remove('bg-primary-50', 'text-primary-700', 'dark:bg-teal-900/30', 'dark:text-teal-400');
            b.classList.add('text-slate-600', 'dark:text-slate-400');
        });
        const activeBtn = document.getElementById(`tab-btn-${tabName}`);
        if(activeBtn) {
            activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400');
            activeBtn.classList.add('bg-primary-50', 'text-primary-700', 'dark:bg-teal-900/30', 'dark:text-teal-400');
        }
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`admin-tab-${tabName}`).classList.remove('hidden');

        if (tabName === 'overview') loadAdminStats();
        if (tabName === 'products') loadAdminProducts();
        if (tabName === 'orders') loadAdminOrders();
        if (tabName === 'users') loadAdminUsers();
    }

    async function loadAdminStats() {
        const [orders, users, products] = await Promise.all([
            api('/api/admin/all'),
            api('/api/admin/users'),
            api('/api/products')
        ]);

        const totalSales = (orders || []).reduce((sum, o) => sum + o.total, 0);
        document.getElementById('stat-sales').innerText = `$${totalSales.toFixed(2)}`;
        document.getElementById('stat-orders-count').innerText = (orders || []).length;
        document.getElementById('stat-users').innerText = (users || []).length;

        const lowStock = (products || []).filter(p => p.stock > 0 && p.stock < 10);
        const outOfStock = (products || []).filter(p => p.stock === 0);

        const renderStockItem = (p, isOut) => `
            <div class="flex justify-between items-center p-2 ${isOut ? 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900/50' : 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-100 dark:border-yellow-900/50'} rounded border text-sm">
                <div>
                    <div class="font-semibold text-slate-700 dark:text-slate-200">${p.name}</div>
                    <div class="${isOut ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'} font-bold">${isOut ? 'Sold Out' : p.stock + ' left'}</div>
                </div>
                <button onclick="restockProduct(${p.id})" class="px-3 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs font-bold hover:bg-teal-50 dark:hover:bg-slate-600 text-teal-600 dark:text-teal-400">Restock</button>
            </div>`;

        document.getElementById('admin-low-stock-list').innerHTML = lowStock.length > 0
            ? lowStock.map(p => renderStockItem(p, false)).join('')
            : `<div class="text-slate-400 text-sm">No low stock items.</div>`;

        document.getElementById('admin-out-stock-list').innerHTML = outOfStock.length > 0
            ? outOfStock.map(p => renderStockItem(p, true)).join('')
            : `<div class="text-slate-400 text-sm">All items in stock.</div>`;

        if(charts['sales']) charts['sales'].destroy();
        if(charts['orders']) charts['orders'].destroy();

        const catSales = {};
        (orders||[]).forEach(o => {
            let items = [];
            try { items = JSON.parse(o.items); } catch(e){}
            items.forEach(i => { catSales[i.category] = (catSales[i.category] || 0) + (i.price*i.quantity); });
        });

        const orderStatus = { 'Processing': 0, 'Cancelled': 0, 'Completed': 0 };
        (orders||[]).forEach(o => orderStatus[o.status] = (orderStatus[o.status]||0) + 1);

        const ctxSales = document.getElementById('chart-sales').getContext('2d');
        charts['sales'] = new Chart(ctxSales, {
            type: 'bar',
            data: { labels: Object.keys(catSales), datasets: [{ label: 'Sales ($)', data: Object.values(catSales), backgroundColor: '#0d9488' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#666' } } }, scales: { y: { ticks: { color: document.documentElement.classList.contains('dark') ? '#ccc' : '#666' } }, x: { ticks: { color: document.documentElement.classList.contains('dark') ? '#ccc' : '#666' } } } }
        });

        const ctxOrders = document.getElementById('chart-orders').getContext('2d');
        charts['orders'] = new Chart(ctxOrders, {
            type: 'pie',
            data: { labels: Object.keys(orderStatus), datasets: [{ data: Object.values(orderStatus), backgroundColor: ['#3b82f6', '#ef4444', '#10b981'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#666' } } } }
        });
    }

    async function restockProduct(id) {
        const qty = prompt("Enter quantity to restock (e.g., 50):");
        if (qty && !isNaN(qty)) {
            await api(`/api/products/${id}/restock`, 'PUT', { quantity: parseInt(qty) });
            showToast("Stock Updated!");
            loadAdminStats();
        }
    }

    async function loadAdminProducts() {
        adminProductsData = await api('/api/products');
        runProductFilter();
    }
    function runProductFilter() {
        const search = document.getElementById('filter-prod-name').value.toLowerCase();
        const minP = parseFloat(document.getElementById('filter-prod-price-min').value) || 0;
        const maxP = parseFloat(document.getElementById('filter-prod-price-max').value) || Infinity;
        const minS = parseFloat(document.getElementById('filter-prod-stock').value) || 0;

        const filtered = adminProductsData.filter(p =>
            p.name.toLowerCase().includes(search) &&
            p.price >= minP && p.price <= maxP &&
            p.stock >= minS
        );
        renderAdminProducts(filtered);
    }
    function renderAdminProducts(data) {
        const html = `
            <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase tracking-wider"><tr><th class="p-5">Name</th><th class="p-5">Price</th><th class="p-5">Stock</th><th class="p-5 text-right">Actions</th></tr></thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">${data.map(p => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <td class="p-5 font-medium text-slate-800 dark:text-slate-200">${p.name}</td>
                        <td class="p-5 text-green-600 dark:text-green-400 font-bold">$${p.price}</td>
                        <td class="p-5"><span class="px-2 py-1 rounded-full text-xs font-bold ${p.stock===0?'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400':p.stock<10?'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400':'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'}">${p.stock}</span></td>
                        <td class="p-5 flex gap-2 justify-end">
                            <button onclick="editProd(${p.id})" class="text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-600 p-2 rounded"><i class="ph ph-pencil-simple"></i></button>
                            <button onclick="delProd(${p.id})" class="text-red-500 hover:bg-red-50 dark:hover:bg-slate-600 p-2 rounded"><i class="ph ph-trash"></i></button>
                        </td>
                    </tr>`).join('')}</tbody>
            </table>`;
        document.getElementById('admin-products-table').innerHTML = html;
    }

    async function loadAdminOrders() {
        adminOrdersData = await api('/api/admin/all');
        runOrderFilter();
    }
    function runOrderFilter() {
        const search = document.getElementById('filter-order-search').value.toLowerCase();
        const status = document.getElementById('filter-order-status').value;
        const sort = document.getElementById('filter-order-sort').value;
        const payment = document.getElementById('filter-order-payment').value;

        let filtered = adminOrdersData.filter(o =>
            (o.id.toString().includes(search) || (o.user_name && o.user_name.toLowerCase().includes(search))) &&
            (status === "" || o.status === status) &&
            (payment === "" || (o.paymentMethod || o.payment_method || '').toLowerCase().includes(payment))
        );

        filtered.sort((a,b) => {
            if(sort === 'date-desc') return new Date(b.date) - new Date(a.date);
            if(sort === 'date-asc') return new Date(a.date) - new Date(b.date);
            if(sort === 'total-desc') return b.total - a.total;
            if(sort === 'total-asc') return a.total - b.total;
            return 0;
        });
        renderAdminOrders(filtered);
    }
    function renderAdminOrders(data) {
        const html = `
            <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase tracking-wider"><tr><th class="p-5">ID</th><th class="p-5">User</th><th class="p-5">Total</th><th class="p-5">Status</th><th class="p-5 text-right">Actions</th></tr></thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">${data.map(o => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="viewAdminOrder(${o.id})" class="cursor-pointer">
                        <td class="p-5 font-medium text-slate-500 dark:text-slate-400">#${o.id}</td>
                        <td class="p-5"><div class="font-bold text-slate-800 dark:text-slate-200">${o.user_name}</div></td>
                        <td class="p-5 font-bold dark:text-white">$${o.total.toFixed(2)}</td>
                        <td class="p-5"><span class="px-3 py-1 rounded-full text-xs font-bold ${o.status==='Processing'?'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300':o.status==='Cancelled'?'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300':'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300'}">${o.status}</span></td>
                        <td class="p-5 text-right flex gap-2 justify-end">
                            <button onclick="event.stopPropagation(); viewAdminOrder(${o.id})" class="text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-3 py-1 rounded text-xs font-bold">View</button>
                            ${o.status === 'Processing' ? `<button onclick="event.stopPropagation(); adminCancelOrder(${o.id})" class="text-red-500 text-xs hover:underline">Cancel</button>` : ''}
                        </td>
                    </tr>`).join('')}</tbody>
            </table>`;
        document.getElementById('admin-orders-table').innerHTML = html;
    }
    function viewAdminOrder(id) {
        const o = adminOrdersData.find(x => x.id === id);
        if(!o) return;
        let items = [];
        try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e){}

        const content = `
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><span class="block text-xs text-slate-500">Order ID</span><span class="font-bold">#${o.id}</span></div>
                <div><span class="block text-xs text-slate-500">Date</span><span class="font-bold">${new Date(o.date).toLocaleDateString()}</span></div>
                <div><span class="block text-xs text-slate-500">User</span><span class="font-bold">${o.user_name}</span></div>
                <div><span class="block text-xs text-slate-500">Email</span><span class="font-bold">${o.user_email || 'N/A'}</span></div>
                <div><span class="block text-xs text-slate-500">Phone</span><span class="font-bold">${o.phone || 'N/A'}</span></div>
                <div><span class="block text-xs text-slate-500">Payment</span><span class="font-bold uppercase">${o.paymentMethod || o.payment_method || 'N/A'}</span></div>
            </div>
            <div class="mb-4">
                <span class="block text-xs text-slate-500">Address</span>
                <p class="font-medium">${o.gov ? o.gov + ' - ' : ''}${o.address || 'N/A'}</p>
            </div>
            <div class="border-t dark:border-slate-700 pt-4">
                <h4 class="font-bold mb-2">Items (${items.length})</h4>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${items.map(i => `<div class="flex justify-between text-xs"><span>${i.name} x${i.quantity}</span><span>$${(i.price*i.quantity).toFixed(2)}</span></div>`).join('')}
                </div>
                <div class="flex justify-between font-bold text-lg mt-4 border-t dark:border-slate-700 pt-2">
                    <span>Total</span><span>$${o.total.toFixed(2)}</span>
                </div>
            </div>
        `;
        document.getElementById('admin-order-content').innerHTML = content;
        document.getElementById('admin-order-modal').classList.remove('hidden');
    }
    async function adminCancelOrder(id) {
        if(confirm("Cancel this user order?")) { await api(`/api/orders/${id}/cancel`, 'PUT'); loadAdminOrders(); }
    }

    async function loadAdminUsers() {
        adminUsersData = await api('/api/admin/users');
        runUserFilter();
    }
    function runUserFilter() {
        const search = document.getElementById('filter-user-search').value.toLowerCase();
        const filtered = adminUsersData.filter(u => u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
        renderAdminUsers(filtered);
    }
    function renderAdminUsers(data) {
        const html = `
            <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase tracking-wider"><tr><th class="p-5">Name</th><th class="p-5">Email</th><th class="p-5">Address (Short)</th><th class="p-5 text-right">Actions</th></tr></thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">${data.map(u => {
            const addr = u.addresses && u.addresses.length > 0 ? u.addresses[0] : null;
            const shortAddr = addr ? (addr.gov ? addr.gov : addr.text.substring(0, 15) + '...') : 'No Address';
            return `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition" onclick="viewAdminUser(${u.id})">
                        <td class="p-5 font-medium text-slate-800 dark:text-slate-200">${u.name}</td>
                        <td class="p-5 text-slate-500 dark:text-slate-400">${u.email}</td>
                        <td class="p-5 text-slate-500 dark:text-slate-400 text-xs">${shortAddr}</td>
                        <td class="p-5 text-right flex gap-2 justify-end">
                            <button onclick="event.stopPropagation(); viewAdminUser(${u.id})" class="text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-3 py-1 rounded-lg text-xs font-bold">View</button>
                            <button onclick="event.stopPropagation(); delUser(${u.id})" class="text-red-600 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 px-3 py-1 rounded-lg text-xs font-bold transition">Remove</button>
                        </td>
                    </tr>`;
        }).join('')}</tbody>
            </table>`;
        document.getElementById('admin-users-table').innerHTML = html;
    }

    function viewAdminUser(id) {
        const u = adminUsersData.find(x => x.id === id);
        if(!u) return;

        const addresses = u.addresses || [];
        let phone = u.phone;
        if(!phone && addresses.length > 0) phone = addresses[0].phone;

        const content = `
            <div class="mb-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-2xl"><i class="ph ph-user"></i></div>
                    <div>
                        <h4 class="text-lg font-bold">${u.name}</h4>
                        <p class="text-slate-500 text-sm">${u.email}</p>
                        <p class="text-slate-500 text-xs">ID: ${u.id}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div><span class="block text-slate-500 text-xs">Role</span><span class="font-bold capitalize">${u.role || 'User'}</span></div>
                    <div><span class="block text-slate-500 text-xs">Phone</span><span class="font-bold">${phone || 'N/A'}</span></div>
                </div>
            </div>
            <div class="border-t dark:border-slate-700 pt-4">
                <h5 class="font-bold mb-2 text-sm">Saved Addresses</h5>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${addresses.length > 0 ? addresses.map(a => `
                        <div class="bg-slate-50 dark:bg-slate-700 p-2 rounded text-xs border dark:border-slate-600">
                            <span class="font-bold block">${a.label}</span>
                            <span>${a.gov ? a.gov + ', ' : ''}${a.text}</span><br>
                            <span class="text-slate-400">${a.phone || ''}</span>
                        </div>
                    `).join('') : '<span class="text-slate-400 text-xs">No addresses saved.</span>'}
                </div>
            </div>
        `;
        document.getElementById('admin-user-content').innerHTML = content;
        document.getElementById('admin-user-modal').classList.remove('hidden');
    }

    async function delUser(id) { if(confirm("Delete User?")) { await api(`/api/admin/users/${id}`, 'DELETE'); loadAdminUsers(); } }
    async function delProd(id) { if(confirm("Delete Product?")) { await api(`/api/products/${id}`, 'DELETE'); loadAdminProducts(); } }

    async function loadUserOrders() {
        const orders = await api('/api/orders');
        const con = document.getElementById('orders-list');
        if(!orders || orders.length === 0) return con.innerHTML = '<div class="text-center text-slate-400 dark:text-slate-500 py-10">No orders yet.</div>';
        con.innerHTML = orders.map(o => `
            <div onclick='showReceipt(${JSON.stringify(o).replace(/'/g, "&apos;")})' class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex justify-between items-center cursor-pointer hover:shadow-md transition">
                <div><div class="font-bold dark:text-white">Order #${o.id}</div><div class="text-sm text-slate-500 dark:text-slate-400">${new Date(o.date).toLocaleDateString()} • $${o.total.toFixed(2)}</div></div>
                <div class="flex items-center gap-4">
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${o.status==='Processing'?'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300':'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300'}">${o.status}</span>
                    ${o.status === 'Processing' ? `<button onclick="event.stopPropagation(); cancelOrder(${o.id})" class="text-red-500 text-sm hover:underline">Cancel</button>` : ''}
                </div>
            </div>`).join('');
    }
    async function cancelOrder(id) { if(confirm("Cancel order?")) { await api(`/api/orders/${id}/cancel`, 'PUT'); loadUserOrders(); } }

    async function openProductModal() {
        const cats = await api('/api/categories');
        document.getElementById('prod-cat').innerHTML = cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        document.getElementById('admin-prod-form').reset(); document.getElementById('prod-id').value=''; document.getElementById('modal-title').innerText="Add Product";
        document.getElementById('product-modal').classList.remove('hidden');
    }

    async function editProd(id) {
        await openProductModal();
        const p = adminProductsData.find(x => x.id === id);
        document.getElementById('prod-id').value = p.id;
        document.getElementById('prod-name').value = p.name;
        document.getElementById('prod-cat').value = p.category;
        document.getElementById('prod-price').value = p.price;
        document.getElementById('prod-stock').value = p.stock;
        document.getElementById('prod-desc').value = p.description;
        document.getElementById('prod-img').value = p.imageUrl;
        document.getElementById('modal-title').innerText = "Edit Product";
    }

    document.getElementById('admin-prod-form').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('prod-id').value;
        const data = { name: document.getElementById('prod-name').value, category: document.getElementById('prod-cat').value, price: document.getElementById('prod-price').value, stock: document.getElementById('prod-stock').value, description: document.getElementById('prod-desc').value, imageUrl: document.getElementById('prod-img').value };
        await api(id?`/api/products/${id}`:'/api/products', id?'PUT':'POST', data);
        document.getElementById('product-modal').classList.add('hidden'); loadAdminProducts(); showToast("Saved");
    };
    async function promptCat() { const n=prompt("New Category:"); if(n){ await api('/api/categories','POST',{name:n}); openProductModal(); } }

    checkAuth(); showPage('page-home');
    updateDarkModeIcon();
</script>
</body>
</html>